\chapter{Materials}\label{chap:4}

\section{Open \acs*{mpmri} data}

\paragraph{\SI{1.5}{\tesla} General Electric scanner}

The \ac{mpmri} data are acquired from a cohort of patients with higher-than-normal level of \ac{psa}.
The acquisition is performed using a \SI{1.5}{\tesla} whole body GE Signa \ac{mri} scanner (General Electric, Milwaukee, WI, USA) with an endorectal coil (Medrad, Pittsburgh, PA, USA), using sequences to obtain \ac{t2w}-\ac{mri}, \ac{dce}-\ac{mri}, \ac{dw}-\ac{mri}, and \ac{mrsi}.
Aside of the \ac{mri} examination, these patients also have undergone a guided-biopsy.
% The dataset is composed of a total of 20 patients of which 18 patients have biopsy proven \ac{cap} and 2 patients are ``healthy'' with negative biopsies.
% Therefore, 13 patients have a \ac{cap} in the \ac{pz}, 3 patients have \ac{cap} in the \ac{cg}, 2 patients have invasive \ac{cap} in both \ac{pz} and \ac{cg}, and finally 2 patients are considered as ``healthy''.
% An experienced radiologist has segmented the prostate organ as well as the prostate zones, and \ac{cap} on the \ac{t2w}-\ac{mri}.

Three-dimensional \ac{t2w} fast spin-echo (\ac{tr}/\ac{te}/\ac{etl}: \SI{3480}{\ms}/\SI{113.6}{\ms}/16, slice thickness: \SI{3}{\mm}) images are then acquired in an oblique axial plane with a  $320 \times 224$ acquisition matrix and a pixel spacing of \SI{0.27}{\milli\metre}.

%The nominal matrix and \ac{fov} of the 3D \ac{t2w} fast spin-echo images are \SI[product-units=repeat]{320x256}{\milli\metre\squared} and \SI[product-units=repeat]{280x240}{\milli\metre\squared}, respectively, thereby affording sub-millimetric pixel resolution within the imaging plane.

\ac{dce}-\ac{mri} is performed using a fat suppressed 3D fast spoiled gradient echo (\ac{tr}/\ac{te}/Flip angle: \SI{4.42}{\ms}/\SI{2.10}{\ms}/\SI{12}{\degree}; Matrix: $320 \times 192$; slab of 40 partitions of \SI{3.5}{\mm} thickness; temporal resolution: \SI{10}{\s}/slab over approximately \SI{5}{\minute}).
A power injector (Medrad, Indianola, USA) is used to provide a bolus injection of Gd-DTPA (Dotarem, Guerbet, Roissy, France) at a dose of \SI{0.2}{\ml} Gd-DTPA/kg of body weight.

\ac{dw}-\ac{mri} images have been acquired using the single-shot spin-echo echo-planar imaging (EPI) technique.
The diffusion-encoding gradients have been applied using a pulsed gradient spin-echo technique resulting in diffusion images acquired at 2 b-values --- i.e., \SI{100}{\second\per\milli\meter\squared} and \SI{1400}{\second\per\milli\meter\squared} --- and in the 3 orthogonal directions.
Sequential sampling of the k-space has been used with a \ac{te} of \SI{100.1}{\ms}, a \ac{tr} of \SI{10825}{\ms}, a bandwidth of \SI{1953}{\hertz\per\px}, and an acquisition matrix size of $128 \times 128$.

\ac{mrsi} is performed using a water and lipid suppressed double-spin-echo point-resolved spectroscopic (PRESS) sequence optimized for quantification detection of choline and citrate metabolites.
Water and lipid have been suppressed using a dual-band spectral spatial pulse technique.
%In order to eliminate signals from adjacent tissues, especially periprostatic lipids and the rectal wall up to 8 outer voxel saturation pulses have been used.
Datasets have been acquired as $16 \times 8 \times 8$ phase-encoded spectral arrays, a \ac{te} of \SI{130}{\ms}, a \ac{tr} of \SI{1000}{\ms}.%, and \SI{13}{\minute} of acquisition time.
%A spectral bandwidth of \SI{1250}{\hertz} has been used with 512 data points.
%A combination of an elliptic weighted averaged k-space acquisition scheme 3D filtering of the signal in k-space have been used, the latter in order to reduce intervoxel signal combination.
%Shimming has been carried out using the Siemenbens 3D Mapshim routine on a voxel adapted to the volume of the entire prostate gland.

\paragraph{\SI{3}{\tesla} Siemens scanner}

The \ac{mpmri} data are acquired from a cohort of patients with higher-than-normal level of \ac{psa}.
The acquisition is performed using a \SI{3}{\tesla} whole body \ac{mri} scanner (Siemens Magnetom Trio TIM, Erlangen, Germany) using sequences to obtain \ac{t2w}-\ac{mri}, \ac{dce}-\ac{mri}, \ac{dw}-\ac{mri}, and \ac{mrsi}.
Aside of the \ac{mri} examination, these patients also have undergone a guided-biopsy.
The dataset is composed of a total of 20 patients of which 18 patients have biopsy proven \ac{cap} and 2 patients are ``healthy'' with negative biopsies.
Therefore, 13 patients have a \ac{cap} in the \ac{pz}, 3 patients have \ac{cap} in the \ac{cg}, 2 patients have invasive \ac{cap} in both \ac{pz} and \ac{cg}, and finally 2 patients are considered as ``healthy''.
An experienced radiologist has segmented the prostate organ --- on \ac{t2w}-\ac{mri}, \ac{dce}-\ac{mri}, and \ac{adc}-\ac{mri} --- as well as the prostate zones --- i.e., \ac{pz} and \ac{cg} ---, and \ac{cap} on the \ac{t2w}-\ac{mri}.

A \SI{3}{\mm} slice fat-suppressed \ac{t2w} fast spin-echo sequence (\ac{tr}/\ac{te}/\ac{etl}: \SI{3400}{\ms}/\SI{85}{\ms}/13) is used to acquire images in sagittal and oblique coronal planes, the latter planes being orientated perpendicular or parallel to the prostate \ac{pz} â€“ rectal wall axis.
Three-dimensional \ac{t2w} fast spin-echo (\ac{tr}/\ac{te}/\ac{etl}: \SI{3600}{\ms}/\SI{143}{\ms}/109, slice thickness: \SI{1.25}{\mm}) images are then acquired in an oblique axial plane.
The nominal matrix and \ac{fov} of the 3D \ac{t2w} fast spin-echo images are \SI[product-units=repeat]{320x256}{\milli\metre\squared} and \SI[product-units=repeat]{280x240}{\milli\metre\squared}, respectively, thereby affording sub-millimetric pixel resolution within the imaging plane.

\ac{dce}-\ac{mri} is performed using a fat suppressed 3D T$_1$ VIBE sequence (\ac{tr}/\ac{te}/Flip angle: \SI{3.25}{\ms}/\SI{1.12}{\ms}/\SI{10}{\degree}; Matrix: $256 \times 192$; \ac{fov}: $280 \times 210$ (with \SI{75}{\percent} rectangular \ac{fov}); slab of 16 partitions of \SI{3.5}{\mm} thickness; temporal resolution: \SI{6}{\s}/slab over approximately \SI{5}{\minute}).
A power injector (Medrad, Indianola, USA) is used to provide a bolus injection of Gd-DTPA (Dotarem, Guerbet, Roissy, France) at a dose of \SI{0.2}{\ml} Gd-DTPA/kg of body weight.

\ac{dw}-\ac{mri} images have been acquired using the single-shot spin-echo echo-planar imaging (EPI) technique.
As proposed by \citeauthor{stejskal1965spin}~\cite{stejskal1965spin}, the diffusion-encoding gradients have been applied using a pulsed gradient spin-echo technique resulting in diffusion images acquired at 2 b-values --- i.e., \SI{100}{\second\per\milli\meter\squared} and \SI{800}{\second\per\milli\meter\squared} --- and in the 3 orthogonal directions.
Sequential sampling of the k-space has been used with a \ac{te} of \SI{101}{\ms}, a \ac{tr} of \SI{4200}{\ms}, and a bandwidth of \SI{1180}{\hertz\per\px}.
Other parameters included a \ac{fov} of \SI{240}{\milli\metre}, an acquisition matrix size of $128 \times 128$ and a slice thickness of \SI{3.5}{\milli\metre}.
The \ac{adc} map has been directly generated by the Siemens workstation from the raw data on a pixel-by-pixel basis.

\ac{mrsi} is performed using a water and lipid suppressed double-spin-echo point-resolved spectroscopic (PRESS) sequence optimized for quantification detection of choline and citrate metabolites.
Water and lipid have been suppressed using a dual-band spectral spatial pulse technique.
In order to eliminate signals from adjacent tissues, especially periprostatic lipids and the rectal wall up to 8 outer voxel saturation pulses have been used.
Datasets have been acquired as $16 \times 12 \times 16$ --- interpolated to $16 \times 16 \times 16$ phase-encoded spectral arrays, a \ac{te} of \SI{140}{\ms}, a \ac{tr} of \SI{720}{\ms} and \SI{13}{\minute} of acquisition time.
A spectral bandwidth of \SI{1250}{\hertz} has been used with 512 data points.
A combination of an elliptic weighted averaged k-space acquisition scheme 3D filtering of the signal in k-space have been used, the latter in order to reduce intervoxel signal combination.
Shimming has been carried out using the Siemenbens 3D Mapshim routine on a voxel adapted to the volume of the entire prostate gland.
Additional unsuppressed water acquisitions at \ac{te} of \SI{30}{\ms}, \SI{80}{\ms}, and \SI{140}{\ms} of \SI{1.5}{\minute} have also been performed in order to allow quantification with respect to prostate water.
Systematic verification of the global shim --- i.e., over the complete 3D PRESS-selected volume --- revealed line widths at half-height of the water peak of the order of \SIrange{20}{30}{\hertz}, routinely.
The line widths for individual voxels are of the order of \SIrange{8}{12}{\hertz}.
The total examination time, including the time spent positioning the patient, is approximately 45 minutes.

\section{Open source}

All the different source code implemented for this thesis have been released to support future development and the possibility to build a consistent benchmark.
All available code is primarily developed in Python with a concern of:
(i) \emph{Quality insurance} by developing unit tests, automatic code quality checking, and code consistency checking using \texttt{PEP8} standards;
(ii) \emph{Continuous integration} is achieved through tools as Travis CI to easily integrate new contributions and ensure back-compatibility;
(iii) \emph{Community-based development} by using collaborative tools --- git, GitHub, and gitter --- to ease collaborative programming, issue tracking, code integration, and idea discussions;
(iv) \emph{Documentation} through a description of the developed API.

Several toolboxes and repository have been designed and are presented in the following sections.

\subsection{\texttt{imbalanced-learn} toolbox}

The \texttt{imbalanced-learn} toolbox is an open-source python toolbox aiming at providing a wide range of methods to cope with the problem of imbalanced dataset frequently encountered in machine learning and pattern recognition.
The implemented state-of-the-art methods can be categorized into 4 groups: (i) under-sampling, (ii) over-sampling, (iii) combination of over- and under-sampling, and (iv) ensemble learning methods.
The proposed toolbox only depends on \texttt{numpy}, \texttt{scipy}, and \texttt{scikit-learn} and is distributed under MIT license.
Furthermore, it is fully compatible with \texttt{scikit-learn} and is part of the \texttt{scikit-learn-contrib} supported project.
Documentation, unit tests as well as integration tests are provided to ease usage and contribution.
The toolbox is publicly available in GitHub\footnote{\url{https://github.com/scikit-learn-contrib/imbalanced-learn}}.

To illustrate the developed API and the compatibility with \texttt{scikit-learn}, an example of a pipeline using a \ac{pca} decomposition, a \ac{smote} over-sampler, and a \ac{knn} classifier is presented below:

\begin{lstlisting}[language=Python, caption=Code snippet to over-sample a dataset using \acs*{smote} in conjunction with \ac{pca} and a \ac{knn} classifer.]
from sklearn.datasets import make_classification
from sklearn.cross_validation import train_test_split as tts
from sklearn.decomposition import PCA
from sklearn.neighbors import KNeighborsClassifier as KNN
from sklearn.metrics import classification_report
from imblearn.over_sampling import SMOTE
from imblearn.pipeline import Pipeline
X, y = make_classification(n_classes=2, class_sep=2,
                           n_informative=3, n_redundant=1, flip_y=0,
                           n_features=20, n_clusters_per_class=1,
                           n_samples=1000, weights=[0.1, 0.9])
pca = PCA()
smt = SMOTE()
knn = KNN()
pipeline = Pipeline([('smt', smt), ('pca', pca), ('knn', knn)])
X_train, X_test, y_train, y_test = tts(X, y, random_state=42)
pipeline.fit(X_train, y_train)
y_hat = pipeline.predict(X_test)
\end{lstlisting}

\subsection{\texttt{protoclass} toolbox}

The \texttt{protoclass} toolbox is an open-source python toolbox providing tools for fast prototyping of machine learning pipeline in medical imaging.
It implements most of the state-of-the-art feature detection techniques presented in \acs{chp}\,\ref{chap:3}.
To illustrate the API, an example is given in which a \ac{t2w}-\ac{mri} volume is normalized and the voxels corresponding to the prostate are extracted and can be used easily with \texttt{scikit-learn}.

\begin{lstlisting}[language=Python, caption=Code snippet to normalize a volume and extract some voxels.]
import os
from protoclass.data_management import T2WModality
from protoclass.data_management import GTModality
from protoclass.preprocessing import GaussianNormalization
from protoclass.extraction import IntensitySignalExtraction

# Define the path the different data path
path_t2w = '/data/T2W'
path_gt = ['/data/GT/prostate']
label_gt = ['prostate']

# Read the T2W
t2w_mod = T2WModality()
t2w_mod.read_data_from_path(path_t2w)

# Read the ground-truth
gt_mod = GTModality()
gt_mod.read_data_from_path(label_gt, path_gt)

# Normalize the T2W modality
t2w_norm = GaussianNormalization(T2WModality())
t2w_norm.fit(t2w_mod, ground_truth=gt_mod, cat=label_gt[0])
t2w_mod = t2w_norm.normalize(t2w_mod, ground_truth=gt_mod,
                             cat=label_gt[0])

# Extract the voxel from the prostate
ise = IntensitySignalExtraction(t2w_mod)
data = ise.transform(t2w_mod, ground_truth=gt_mod, cat=label_gt[0])
\end{lstlisting}

\subsection{Pipeline-data releases}

\section{Website development}
